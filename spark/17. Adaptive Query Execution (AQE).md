# 17. Adaptive Query Execution (AQE) ♻️

**AQE** dynamically optimizes queries at runtime based on actual data statistics.

```python
spark = SparkSession.builder \
    .config("spark.sql.adaptive.enabled", "true") \
    .config("spark.sql.adaptive.skewJoin.enabled", "true") \
    .config("spark.sql.adaptive.coalescePartitions.enabled", "true") \
    .config("spark.sql.adaptive.skewJoin.skewThreshold", "5") \
    .getOrCreate()
```

### AQE Features

#### 1. Dynamic Coalescing

Reduces shuffle partitions based on actual data size:

```
Original: 200 shuffle partitions (may be too many if little data)
↓
AQE: Detects data size, coalesces to 50 partitions
(Reduces overhead, faster execution)
```

#### 2. Skew Join Optimization

Detects and handles skewed data:

```python
# Original: 1000 rows in partition 0, 1 row in partition 999
# This creates severe load imbalance

# AQE: Detects skew, splits partition 0 into 10 sub-partitions
# Distributes load more evenly
```

#### 3. Join Strategy Adaptation

Changes join type based on runtime statistics:

```python
# Originally: Sort-merge join planned
# Runtime: Sees one table is smaller, switches to broadcast join
# No shuffle needed, massive performance gain
```
